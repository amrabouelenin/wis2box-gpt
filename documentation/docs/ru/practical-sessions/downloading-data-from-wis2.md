---
title: Загрузка и декодирование данных из WIS2
---

# Загрузка и декодирование данных из WIS2

!!! abstract "Учебные результаты!"

    К концу этой практической сессии вы сможете:

    - использовать "wis2downloader" для подписки на уведомления данных WIS2 и загрузки данных на вашу локальную систему
    - просматривать статус загрузок в панели управления Grafana
    - декодировать некоторые загруженные данные с помощью контейнера "decode-bufr-jupyter"

## Введение

На этом занятии вы научитесь настраивать подписку на брокера WIS2 и автоматически загружать данные на вашу локальную систему с помощью сервиса "wis2downloader", включенного в wis2box.

!!! note "О wis2downloader"
     
     Wis2downloader также доступен как самостоятельный сервис, который может быть запущен на другой системе, отличной от той, которая публикует уведомления WIS2. Смотрите [wis2downloader](https://pypi.org/project/wis2downloader/) для получения дополнительной информации о использовании wis2downloader как самостоятельного сервиса.

     Если вы хотите разработать свой собственный сервис для подписки на уведомления WIS2 и загрузки данных, вы можете использовать [исходный код wis2downloader](https://github.com/wmo-im/wis2downloader) в качестве справочника.

!!! Other tools for accessing WIS2 data

    Следующие инструменты также могут быть использованы для поиска и доступа к данным из WIS2:

    - [pywiscat](https://github.com/wmo-im/pywiscat) предоставляет возможности поиска в глобальном каталоге обнаружения WIS2 в поддержку отчетности и анализа каталога WIS2 и связанных с ним метаданных обнаружения
    - [pywis-pubsub](https://github.com/wmo-im/pywis-pubsub) предоставляет возможности подписки и загрузки данных ВМО из сервисов инфраструктуры WIS2

## Подготовка

Перед началом, пожалуйста, войдите в вашу учебную виртуальную машину и убедитесь, что ваш экземпляр wis2box работает.

## Упражнение 1: просмотр панели управления wis2download в Grafana

Откройте веб-браузер и перейдите на панель управления Grafana для вашего экземпляра wis2box, перейдя по адресу `http://<ваш-хост>:3000`.

Нажмите на панели слева на пункт "dashboards", затем выберите **панель управления wis2downloader**.

Вы должны увидеть следующую панель управления:

![Панель управления wis2downloader](../assets/img/wis2downloader-dashboard.png)

Эта панель управления основана на метриках, публикуемых сервисом wis2downloader, и покажет вам статус текущих загрузок.

В левом верхнем углу вы можете видеть текущие активные подписки.

Оставьте эту панель управления открытой, так как вы будете использовать её для мониторинга прогресса загрузки в следующем упражнении.

## Упражнение 2: проверка конфигурации wis2downloader

Сервис wis2downloader, запущенный стеком wis2box, можно настроить с помощью переменных окружения, определенных в вашем файле wis2box.env.

Следующие переменные окружения используются wis2downloader:

    - DOWNLOAD_BROKER_HOST: имя хоста брокера MQTT, к которому следует подключаться. По умолчанию globalbroker.meteo.fr
    - DOWNLOAD_BROKER_PORT: порт брокера MQTT, к которому следует подключаться. По умолчанию 443 (HTTPS для веб-сокетов)
    - DOWNLOAD_BROKER_USERNAME: имя пользователя для подключения к брокеру MQTT. По умолчанию everyone
    - DOWNLOAD_BROKER_PASSWORD: пароль для подключения к брокеру MQTT. По умолчанию everyone
    - DOWNLOAD_BROKER_TRANSPORT: веб-сокеты или tcp, механизм транспортировки для подключения к брокеру MQTT. По умолчанию веб-сокеты,
    - DOWNLOAD_RETENTION_PERIOD_HOURS: период хранения загруженных данных в часах. По умолчанию 24
    - DOWNLOAD_WORKERS: количество рабочих для загрузки. По умолчанию 8. Определяет количество параллельных загрузок.
    - DOWNLOAD_MIN_FREE_SPACE_GB: минимальный свободный объем в ГБ, который следует сохранять на томе, на котором хранятся загрузки. По умолчанию 1.

Для проверки текущей конфигурации wis2downloader вы можете использовать следующую команду:

```bash
cat ~/wis2box-1.0.0rc1/wis2box.env | grep DOWNLOAD
```

!!! question "Проверьте конфигурацию wis2downloader"
    
    Какой брокер MQTT по умолчанию использует wis2downloader для подключения?

    Какой период хранения загруженных данных по умолчанию?

??? success "Нажмите, чтобы увидеть ответ"

    Брокер MQTT по умолчанию, к которому подключается wis2downloader, это `globalbroker.meteo.fr`.

    Период хранения загруженных данных по умолчанию составляет 24 часа.

!!! note "Обновление конфигурации wis2downloader"

    Для обновления конфигурации wis2downloader вы можете отредактировать файл wis2box.env. Чтобы применить изменения, вы можете повторно запустить команду запуска стека wis2box:

    ```bash
    python3 wis2box-ctl.py start
    ```

    И вы увидите, как сервис wis2downloader перезапускается с новой конфигурацией.

Вы можете сохранить конфигурацию по умолчанию для целей этого упражнения.

## Упражнение 3: добавление подписок в wis2downloader

Внутри контейнера **wis2downloader** вы можете использовать командную строку для просмотра, добавления и удаления подписок.

Для входа в контейнер **wis2downloader** используйте следующую команду:

```bash
python3 wis2box-ctl.py login wis2downloader
```

Затем используйте следующую команду для просмотра активных на данный момент подписок:

```bash
wis2downloader list-subscriptions
```

Эта команда вернет пустой список, так как в настоящее время активных подписок нет.

Для целей этого упражнения мы подпишемся на следующую тему `cache/a/wis2/de-dwd-gts-to-wis2/#`, чтобы подписаться на данные, публикуемые шлюзом GTS-to-WIS2, размещенным DWD, и уведомления о загрузках из глобального кэша.

Для добавления этой подписки используйте следующую команду:

```bash
wis2downloader add-subscription --topic cache/a/wis2/de-dwd-gts-to-wis2/#
```

Затем выйдите из контейнера **wis2downloader**, набрав `exit`:

```bash
exit
```

Проверьте панель управления wis2downloader в Grafana, чтобы увидеть добавленную новую подписку. Подождите несколько минут, и вы должны увидеть начало первых загрузок. Переходите к следующему упражнению, как только подтвердите, что загрузки начались.

## Упражнение 4: просмотр загруженных данных

Сервис wis2downloader в стеке wis2box загружает данные в каталог 'downloads' в каталоге, который вы определили как WIS2BOX_HOST_DATADIR в вашем файле wis2box.env. Чтобы просмотреть содержимое каталога загрузок, вы можете использовать следующую команду:

```bash
ls -R ~/wis2box-data/downloads
```

Обратите внимание, что загруженные данные хранятся в каталогах, названных в соответствии с темой, на которую было опубликовано уведомление WIS2.

## Упражнение 5: удаление подписок из wis2downloader

Затем снова войдите в контейнер wis2downloader:

```bash
python3 wis2box-ctl.py login wis2downloader
```

и удалите подписку, которую вы сделали из wis2downloader, используя следующую команду:

```bash
wis2downloader remove-subscription --topic cache/a/wis2/de-dwd-gts-to-wis2/#
```

И выйдите из контейнера wis2downloader, набрав `exit`:
    
```bash
exit
```

Проверьте панель управления wis2downloader в Grafana, чтобы увидеть удаленную подписку. Вы должны увидеть, что загрузки остановились.

## Упражнение 6: подписка на wis2training-broker и настройка новой подписки

Для следующего упражнения мы подпишемся на wis2training-broker.

Это демонстрирует, как подписаться на брокера, который не является брокером по умолчанию, и позволит вам загрузить некоторые данные, опубликованные брокером WIS2 Training.

Отредактируйте файл wis2box.env и измените DOWNLOAD_BROKER_HOST на `wis2training-broker.wis2dev.io`, измените DOWNLOAD_BROKER_PORT на `1883` и измените DOWNLOAD_BROKER_TRANSPORT на `tcp`:

```copy
# настройки загрузчика
DOWNLOAD_BROKER_HOST=wis2training-broker.wis2dev.io
DOWNLOAD_BROKER_PORT=1883
DOWNLOAD_BROKER_USERNAME=everyone
DOWNLOAD_BROKER_PASSWORD=everyone
# механизм транспортировки загрузки (tcp или веб-сокеты)
DOWNLOAD_BROKER_TRANSPORT=tcp
```

Затем перезапустите стек wis2box, чтобы применить изменения:

```bash
python3 wis2box-ctl.py start
```

Проверьте журналы wis2downloader, чтобы увидеть, было ли подключение к новому брокеру успешным:

```bash
docker logs wis2downloader
```

Вы должны увидеть следующее сообщение журнала:

```copy
...
INFO - Подключение...
INFO - Хост: wis2training-broker.wis2dev.io, порт: 1883
INFO - Успешно подключено
```

Теперь мы настроим новую подписку на тему для загрузки данных о траекториях циклонов с брокера WIS2 Training.

Войдите в контейнер **wis2downloader**:

```bash
python3 wis2box-ctl.py login wis2downloader
```

И выполните следующую команду (скопируйте и вставьте это, чтобы избежать опечаток):

```bash
wis2downloader add-subscription --topic origin/a/wis2/int-wis2-training/data/core/weather/prediction/forecast/medium-range/probabilistic/trajectory
```

Выйдите из контейнера **wis2downloader**, набрав `exit`.

Подождите, пока не увидите начало загрузок на панели управления wis2downloader в Grafana.

!!! note "Загрузка данных с брокера WIS2 Training"

    Брокер WIS2 Training - это тестовый брокер, который используется в учебных целях и может не публиковать данные все время.

    Во время очных учебных сессий местный тренер обеспечит публикацию данных брокером WIS2 Training для вашей загрузки.

    Если вы выполняете это упражнение вне учебной сессии, вы можете не увидеть загружаемых данных.

Проверьте, были ли загружены данные, снова проверив журналы wis2downloader:

```bash
docker logs wis2downloader
```

Вы должны увидеть сообщение журнала, аналогичное следующему:

```copy
[...] INFO - Сообщение получено по теме origin/a/wis2/int-wis2-training/data/core/weather/prediction/forecast/medium-range/probabilistic/trajectory
[...] INFO - Загружено A_JSXX05ECEP020000_C_ECMP_...
```

## Упражнение 7: декодирование загруженных данных

Чтобы продемонстрировать, как вы можете декодировать загруженные данные, мы запустим новый контейнер с использованием образа 'decode-bufr-jupyter'.

Этот контейнер запустит сервер Jupyter notebook на вашем экземпляре, который включает библиотеку "ecCodes", которую вы можете использовать для декодирования данных BUFR.

Мы будем использовать примерные тетради, включенные в `~/exercise-materials/notebook-examples`, чтобы декодировать загруженные данные для траекторий тропических циклонов.

Для запуска контейнера используйте следующую команду:

```bash
docker run -d --name decode-bufr-jupyter \
    -v ~/wis2box-data/downloads:/root/downloads \
    -p 8888:8888 \
    -e JUPYTER_TOKEN=dataismagic! \
    mlimper/decode-bufr-jupyter
```

!!! note "О контейнере decode-bufr-jupyter"

    Контейнер `decode-bufr-jupyter` - это пользовательский контейнер, который включает библиотеку ecCodes и запускает сервер Jupyter notebook. Контейнер основан на образе, который включает библиотеку `ecCodes` для декодирования данных BUFR, наряду с библиотеками для построения графиков и анализа данных.

    Приведенная выше команда запускает контейнер в отсоединенном режиме, с именем `decode-bufr-jupyter`, порт 8888 сопоставляется с хост-системой, и переменная окружения `JUPYTER_TOKEN` устанавливается в `dataismagic!`.
    
    Приведенная выше команда также монтирует каталог `~/wis2box-data/downloads` в `/root/downloads` в контейнере. Это гарантирует, что загру