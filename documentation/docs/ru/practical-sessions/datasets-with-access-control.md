---
title: Настройка рекомендуемого набора данных с контролем доступа
---

# Настройка рекомендуемого набора данных с контролем доступа

!!! abstract "Учебные результаты"
    К концу этого практического занятия вы сможете:

    - создать новый набор данных с политикой данных 'рекомендуемый'
    - добавить токен доступа к набору данных
    - проверить, что набор данных не может быть доступен без токена доступа
    - добавить токен доступа в HTTP-заголовки для доступа к набору данных

## Введение

Наборы данных, которые не считаются 'основными' в WMO, могут быть настроены с политикой контроля доступа. wis2box предоставляет механизм добавления токена доступа к набору данных, который будет предотвращать скачивание данных пользователями, если они не предоставят токен доступа в HTTP-заголовках.

## Подготовка

Убедитесь, что у вас есть доступ по SSH к вашей учебной VM и что ваш экземпляр wis2box работает.

Убедитесь, что вы подключены к брокеру MQTT вашего экземпляра wis2box с помощью MQTT Explorer. Вы можете использовать общедоступные учетные данные `everyone/everyone` для подключения к брокеру.

Убедитесь, что у вас открыт веб-браузер с веб-приложением wis2box для вашего экземпляра, перейдя по адресу `http://<your-host>/wis2box-webapp`.

## Упражнение 1: создайте новый набор данных с политикой данных 'рекомендуемый'

Перейдите на страницу 'редактор наборов данных' в веб-приложении wis2box и создайте новый набор данных. Используйте тот же centre-id, что и в предыдущих практических занятиях, и используйте шаблон='surface-weather-observations/synop'.

Нажмите 'OK' для продолжения.

В редакторе наборов данных установите политику данных на 'рекомендуемый' (обратите внимание, что изменение политики данных обновит 'Иерархию тем').
Замените автоматически сгенерированный 'Локальный ID' описательным именем для набора данных, например, 'recommended-data-with-access-control':

<img alt="create-dataset-recommended" src="../../assets/img/create-dataset-recommended.png" width="800">

Продолжайте заполнять необходимые поля для Пространственных свойств и Контактной информации, и 'Проверьте форму' на наличие ошибок.

Наконец, отправьте набор данных, используя ранее созданный токен аутентификации, и проверьте, что новый набор данных создан в веб-приложении wis2box.

Проверьте MQTT-explorer, чтобы увидеть, что вы получили сообщение WIS2 Notification Message, объявляющее о новой записи метаданных обнаружения на тему `origin/a/wis2/<your-centre-id>/metadata`.

## Упражнение 2: добавьте токен доступа к набору данных

Войдите в контейнер управления wis2box,

```bash
cd ~/wis2box-1.0.0rc1
python3 wis2box-ctl.py login
```

Из командной строки внутри контейнера вы можете защитить набор данных с помощью команды `wis2box auth add-token`, используя флаг `--metadata-id` для указания идентификатора метаданных набора данных и токен доступа в качестве аргумента.

Например, чтобы добавить токен доступа `S3cr3tT0k3n` к набору данных с идентификатором метаданных `urn:wmo:md:not-my-centre:core.surface-based-observations.synop`:

```bash
wis2box auth add-token --metadata-id urn:wmo:md:not-my-centre:reco.surface-based-observations.synop S3cr3tT0k3n
```

Выйдите из контейнера управления wis2box:

```bash
exit
```

## Упражнение 3: опубликуйте некоторые данные в набор данных

Скопируйте файл `exercise-materials/access-control-exercises/aws-example2.csv` в каталог, определенный `WIS2BOX_HOST_DATADIR` в вашем `wis2box.env`:

```bash
cp ~/exercise-materials/access-control-exercises/aws-example2.csv ~/wis2box-data
```

Затем используйте WinSCP или редактор командной строки для редактирования файла `aws-example2.csv` и обновите идентификаторы станций WIGOS во входных данных, чтобы они соответствовали станциям в вашем экземпляре wis2box.

Затем перейдите в редактор станций в веб-приложении wis2box. Для каждой станции, которую вы использовали в `aws-example2.csv`, обновите поле 'тема' так, чтобы оно соответствовало 'теме' набора данных, который вы создали в предыдущем упражнении.

Теперь эта станция будет ассоциирована с 2 темами, одна для 'основного' набора данных и одна для 'рекомендуемого' набора данных:

<img alt="edit-stations-add-topics" src="../../assets/img/edit-stations-add-topics.png" width="600">

Вам нужно будет использовать ваш токен для `collections/stations`, чтобы сохранить обновленные данные станции.

Затем войдите в контейнер управления wis2box:

```bash
cd ~/wis2box-1.0.0rc1
python3 wis2box-ctl.py login
```

Из командной строки wis2box мы можем загрузить файл образца данных `aws-example2.csv` в определенный набор данных следующим образом:

```bash
wis2box data ingest -p /data/wis2box/aws-example2.csv --metadata-id urn:wmo:md:not-my-centre:reco.surface-based-observations.synop
```

Убедитесь, что вы указали правильный идентификатор метаданных для вашего набора данных и **проверьте, что вы получаете уведомления о данных WIS2 в MQTT Explorer**, на тему `origin/a/wis2/<your-centre-id>/data/recommended/surface-based-observations/synop`.

Проверьте каноническую ссылку в сообщении уведомления WIS2 и скопируйте/вставьте ссылку в браузер, чтобы попытаться скачать данные.

Вы должны увидеть ошибку 403 Forbidden.

## Упражнение 4: добавьте токен доступа в HTTP-заголовки для доступа к набору данных

Чтобы продемонстрировать, что токен доступа необходим для доступа к набору данных, мы воспроизведем ошибку, которую вы видели в браузере, используя функцию командной строки `wget`.

Из командной строки в вашей учебной VM используйте команду `wget` с канонической ссылкой, которую вы скопировали из сообщения уведомления WIS2.

```bash
wget <canonical-link>
```

Вы должны увидеть, что HTTP-запрос возвращается с *401 Unauthorized* и данные не скачиваются.

Теперь добавьте токен доступа в HTTP-заголовки для доступа к набору данных.

```bash
wget --header="Authorization: Bearer S3cr3tT0k3n" <canonical-link>
```

Теперь данные должны быть успешно скачаны.

## Заключение

!!! success "Поздравляем!"
    В ходе этого практического занятия вы научились:

    - создавать новый набор данных с политикой данных 'рекомендуемый'
    - добавлять токен доступа к набору данных
    - проверять, что набор данных не может быть доступен без токена доступа
    - добавлять токен доступа в HTTP-заголовки для доступа к набору данных