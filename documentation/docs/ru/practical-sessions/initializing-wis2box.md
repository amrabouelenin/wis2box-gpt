---
title: Инициализация wis2box
---

# Инициализация wis2box

!!! abstract "Учебные результаты"

    К концу этой практической сессии вы сможете:

    - запустить скрипт `wis2box-create-config.py` для создания начальной конфигурации
    - запустить wis2box и проверить статус его компонентов
    - получить доступ к **wis2box-webapp**, API, пользовательскому интерфейсу MinIO и панели управления Grafana в браузере
    - подключиться к локальному **wis2box-broker** с использованием MQTT Explorer

!!! note

    Текущие учебные материалы используют wis2box-1.0.0rc1.
    
    Смотрите [accessing-your-student-vm](accessing-your-student-vm.md) для инструкций по загрузке и установке стека программного обеспечения wis2box, если вы проводите обучение вне локальной учебной сессии.

## Подготовка

Войдите в свою назначенную виртуальную машину с вашим именем пользователя и паролем и убедитесь, что вы находитесь в директории `wis2box-1.0.0rc1`:

```bash
cd ~/wis2box-1.0.0rc1
```

## Создание начальной конфигурации

Начальная конфигурация для wis2box требует:

- файла окружения `wis2box.env`, содержащего параметры конфигурации
- директории на хост-машине для обмена между хост-машиной и контейнерами wis2box, определяемой переменной окружения `WIS2BOX_HOST_DATADIR`

Скрипт `wis2box-create-config.py` можно использовать для создания начальной конфигурации вашего wis2box.

Он задаст вам ряд вопросов для настройки вашей конфигурации.

Вы сможете просмотреть и обновить файлы конфигурации после завершения работы скрипта.

Запустите скрипт следующим образом:

```bash
python3 wis2box-create-config.py
```

### Директория wis2box-host-data

Скрипт попросит вас ввести директорию для использования переменной окружения `WIS2BOX_HOST_DATADIR`.

Обратите внимание, что вам нужно определить полный путь к этой директории.

Например, если ваше имя пользователя `username`, полный путь к директории будет `/home/username/wis2box-data`:

```{.copy}
username@student-vm-username:~/wis2box-1.0.0rc1$ python3 wis2box-create-config.py
Пожалуйста, введите директорию для использования WIS2BOX_HOST_DATADIR:
/home/username/wis2box-data
Директория для использования WIS2BOX_HOST_DATADIR будет установлена в:
    /home/username/wis2box-data
Это верно? (y/n/exit)
y
Директория /home/username/wis2box-data была создана.
```

### URL wis2box

Затем вас попросят ввести URL вашего wis2box. Это URL, который будет использоваться для доступа к веб-приложению wis2box, API и UI.

Пожалуйста, используйте `http://<your-hostname-or-ip>` в качестве URL.

```{.copy}
Пожалуйста, введите URL wis2box:
 Для локального тестирования URL будет http://localhost
 Для удаленного доступа URL должен указывать на публичный IP-адрес или доменное имя сервера, на котором размещен wis2box.
http://username.wis2.training
URL wis2box будет установлен в:
  http://username.wis2.training
Это верно? (y/n/exit)
```

### Пароли WEBAPP, STORAGE и BROKER

Вы можете использовать опцию генерации случайного пароля, когда будете подсказаны для `WIS2BOX_WEBAPP_PASSWORD`, `WIS2BOX_STORAGE_PASSWORD`, `WIS2BOX_BROKER_PASSWORD` и определите свой собственный.

Не беспокойтесь о том, чтобы запомнить эти пароли, они будут сохранены в файле `wis2box.env` в вашей директории wis2box-1.0.0rc1.

### Просмотр `wis2box.env`

После завершения работы скриптов проверьте содержимое файла `wis2box.env` в вашей текущей директории:

```bash
cat ~/wis2box-1.0.0rc1/wis2box.env
```

Или проверьте содержимое файла через WinSCP.

!!! question

    Каково значение WISBOX_BASEMAP_URL в файле wis2box.env?

??? success "Нажмите, чтобы увидеть ответ"

    Значение по умолчанию для WIS2BOX_BASEMAP_URL — `https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png`.

    Этот URL ссылается на сервер тайлов OpenStreetMap. Если вы хотите использовать другого провайдера карт, вы можете изменить этот URL, чтобы он указывал на другой сервер тайлов.

!!! question 

    Каково значение переменной окружения WIS2BOX_STORAGE_DATA_RETENTION_DAYS в файле wis2box.env?

??? success "Нажмите, чтобы увидеть ответ"

    Значение по умолчанию для WIS2BOX_STORAGE_DATA_RETENTION_DAYS — 30 дней. Вы можете изменить это значение на другое количество дней, если хотите.
    
    Контейнер wis2box-management запускает cronjob ежедневно, чтобы удалять данные, старше количества дней, определенных переменной WIS2BOX_STORAGE_DATA_RETENTION_DAYS, из корзины `wis2box-public` и бэкенда API:
    
    ```{.copy}
    0 0 * * * su wis2box -c "wis2box data clean --days=$WIS2BOX_STORAGE_DATA_RETENTION_DAYS"
    ```

!!! note

    Файл `wis2box.env` содержит переменные окружения, определяющие конфигурацию вашего wis2box. Для получения дополнительной информации обратитесь к [wis2box-documentation](https://docs.wis2box.wis.wmo.int/en/latest/reference/configuration.html).

    Не редактируйте файл `wis2box.env`, если вы не уверены в вносимых изменениях. Неправильные изменения могут привести к тому, что ваш wis2box перестанет работать.

    Не делитесь содержимым файла `wis2box.env` с кем-либо, так как он содержит конфиденциальную информацию, такую как пароли.

## Запуск wis2box

Убедитесь, что вы находитесь в директории, содержащей файлы определения стека программного обеспечения wis2box:

```{.copy}
cd ~/wis2box-1.0.0rc1
```

Запустите wis2box с помощью следующей команды:

```{.copy}
python3 wis2box-ctl.py start
```

При первом запуске этой команды вы увидите следующий вывод:

```
Не найдены файлы docker-compose.images-*.yml, создание одного
Текущая версия=Undefined, последняя версия=1.0.0rc1
Хотите обновить? (y/n/exit)
```

Выберите ``y``, и скрипт создаст файл ``docker-compose.images-1.0.0rc1.yml``, загрузит необходимые образы Docker и запустит сервисы.

Загрузка образов может занять некоторое время в зависимости от скорости вашего интернет-соединения. Этот шаг требуется только при первом запуске wis2box.

Проверьте статус с помощью следующей команды:

```{.copy}
python3 wis2box-ctl.py status
```

Повторите эту команду, пока все сервисы не будут запущены и работают.

!!! note "wis2box и Docker"
    wis2box работает как набор контейнеров Docker, управляемых docker-compose.
    
    Сервисы определены в различных файлах `docker-compose*.yml`, которые можно найти в директории `~/wis2box-1.0.0rc1/`.
    
    Python-скрипт `wis2box-ctl.py` используется для выполнения команд Docker Compose, которые управляют сервисами wis2box.

    Вам не нужно знать детали контейнеров Docker для работы со стеком программного обеспечения wis2box, но вы можете изучить файлы `docker-compose*.yml`, чтобы увидеть, как определены сервисы. Если вы заинтересованы в изучении Docker, вы можете найти дополнительную информацию в [Docker documentation](https://docs.docker.com/).

Для входа в контейнер wis2box-management используйте следующую команду:

```{.copy}
python3 wis2box-ctl.py login
```

Внутри контейнера wis2box-management вы можете выполнить различные команды для управления вашим wis2box, такие как:

- `wis2box auth add-token --path processes/wis2box` : для создания токена авторизации для конечной точки `processes/wis2box`
- `wis2box data clean --days=<number-of-days>` : для очистки данных, старше определенного количества дней, из корзины `wis2box-public`

Чтобы выйти из контейнера и вернуться на хост-машину, используйте следующую команду:

```{.copy}
exit
```

Выполните следующую команду, чтобы увидеть работающие на вашей хост-машине контейнеры Docker:

```{.copy}
docker ps
```

Вы должны увидеть следующие работающие контейнеры:

- wis2box-management
- wis2box-api
- wis2box-minio
- wis2box-webapp
- wis2box-auth
- wis2box-ui
- wis2downloader
- elasticsearch
- elasticsearch-exporter
- nginx
- mosquitto
- prometheus
- grafana
- loki

Эти контейнеры являются частью стека программного обеспечения wis2box и предоставляют различные сервисы, необходимые для работы wis2box.

Выполните следующую команду, чтобы увидеть работающие на вашей хост-машине тома Docker:

```{.copy}
docker volume ls
```

Вы должны увидеть следующие тома:

- wis2box_project_auth-data
- wis2box_project_es-data
- wis2box_project_htpasswd
- wis2box_project_minio-data
- wis2box_project_prometheus-data
- wis2box_project_loki-data

А также некоторые анонимные тома, используемые различными контейнерами.

Тома, начинающиеся с `wis2box_project_`, используются для хранения постоянных данных для различных сервисов в стеке программного обеспечения wis2box.

## API wis2box

wis2box содержит API (интерфейс программирования приложений), который предоставляет доступ к данным и процессы для интерактивной визуализации, преобразования данных и публикации.

Откройте новую вкладку и перейдите на страницу `http://<your-host>/oapi`.

<img alt="wis2box-api.png" src="../../assets/img/wis2box-api.png" width="800">

Это стартовая страница API wis2box (работает через контейнер **wis2box-api**).

!!! question
     
     Какие коллекции в настоящее время доступны?

??? success "Нажмите, чтобы увидеть ответ"
    
    Чтобы просмотреть коллекции, в настоящее время доступные через API, нажмите `Посмотреть коллекции в этом сервисе`:

    <img alt="wis2box-api-collections.png" src="../../assets/img/wis2box-api-collections.png" width="600">

    В настоящее время доступны следующие коллекции:

    - Станции
    - Уведомления о данных
    - Метаданные обнаружения


!!! question

    Сколько уведомлений о данных было опубликовано?

??? success "Нажмите, чтобы увидеть ответ"

    Нажмите на "Уведомления о данных", затем нажмите на `Просмотреть элементы "Уведомления о данных"`. 
    
    Вы заметите, что на странице написано "Нет элементов", так как уведомления о данных еще не были опубликованы.

## Веб-приложение wis2box

Откройте веб-браузер и посетите страницу `http://<your-host>/wis2box-webapp`.

Вы увидите всплывающее окно с запросом имени пользователя и пароля. Используйте имя пользователя по умолчанию `wis2box-user` и `WIS2BOX_WEBAPP_PASSWORD`, определенный в файле `wis2box.env`, и нажмите "Войти":

!!! note 

    Проверьте ваш wis2box.env на предмет значения WIS2BOX_WEBAPP_PASSWORD. Вы можете использовать следующую команду, чтобы проверить значение этой переменной окружения:

    ```{.copy}
    cat ~/wis2box-1.0.0rc1/wis2box.env | grep WIS2BOX_WEBAPP_PASSWORD
    ```

После входа в систему переместите курсор мыши в меню слева, чтобы увидеть доступные опции в веб-приложении wis2box:

<img alt="wis2box-webapp-menu.png" src="../../assets/img/wis2box-webapp-menu.png" width="400">

Это веб-приложение wis2box позволяет вам взаимодействовать с вашим wis2box:

- создавать и управлять наборами данных
- обновлять/просматривать метаданные вашей станции
- загружать данные в форматах ASCII и CSV
- мониторить уведомления, опубликованные на вашем wis2box-broker

Мы будем использовать это веб-приложение на последующих занятиях.

## wis2box-broker

Откройте MQTT Explorer на вашем компьютере и подготовьте новое подключение для подключения к вашему брокеру (работает через контейнер **wis2box-broker**).

Нажмите `+`, чтобы добавить новое подключение:

<img alt="mqtt-explorer-new-connection.png" src="../../assets/img/mqtt-explorer-new-connection.png" width="300">

Вы можете нажать на кнопку 'ADVANCED' и убедиться, что у вас есть подписки на следующие темы:

- `#`
- `$SYS/#`

<img alt="mqtt-explorer-topics.png" src="../../assets/img/mqtt-explorer-topics.png" width="550">

!!! note

    Тема `#` является подпиской с подстановочным знаком, которая подписывает на все темы, пуб